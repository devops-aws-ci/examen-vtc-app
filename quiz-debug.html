<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>QCM VTC - Debug</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background: #f5f5f5;
        }
        .debug-info {
            background: #e3f2fd;
            border: 1px solid #2196f3;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 20px;
        }
        .error {
            background: #ffebee;
            border: 1px solid #f44336;
            color: #d32f2f;
        }
        .success {
            background: #e8f5e8;
            border: 1px solid #4caf50;
            color: #2e7d32;
        }
        .question-card {
            background: white;
            border-radius: 8px;
            padding: 20px;
            margin: 20px 0;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .option {
            background: #f8f9fa;
            border: 2px solid #dee2e6;
            border-radius: 8px;
            padding: 10px;
            margin: 10px 0;
            cursor: pointer;
        }
        .option:hover {
            background: #e9ecef;
        }
        .option.selected {
            background: #e3f2fd;
            border-color: #2196f3;
        }
        button {
            background: #2196f3;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover {
            background: #1976d2;
        }
        button:disabled {
            background: #ccc;
            cursor: not-allowed;
        }
    </style>
</head>
<body>
    <h1>QCM VTC - Mode Debug</h1>
    
    <div id="debugInfo" class="debug-info">
        <h3>Informations de debug :</h3>
        <div id="debugContent">Initialisation...</div>
    </div>
    
    <div id="quizContent" style="display: none;">
        <div id="quizHeader">
            <h2 id="quizTitle">Titre du Quiz</h2>
            <p>Question <span id="currentQ">1</span> / <span id="totalQ">?</span> | Score: <span id="score">0</span></p>
        </div>
        
        <div class="question-card">
            <h3 id="questionText">Question en cours de chargement...</h3>
            <div id="optionsContainer"></div>
        </div>
        
        <div>
            <button id="prevBtn" onclick="previousQuestion()" disabled>Précédent</button>
            <button id="nextBtn" onclick="nextQuestion()">Suivant</button>
            <button onclick="goHome()">Retour Accueil</button>
        </div>
    </div>
    
    <script>
        let quizData = null;
        let quizConfig = null;
        let currentQuestionIndex = 0;
        let userAnswers = [];
        let score = 0;
        
        function updateDebugInfo(message, type = 'info') {
            const debugContent = document.getElementById('debugContent');
            const debugInfo = document.getElementById('debugInfo');
            
            debugContent.innerHTML += `<p>[${new Date().toLocaleTimeString()}] ${message}</p>`;
            
            if (type === 'error') {
                debugInfo.className = 'debug-info error';
            } else if (type === 'success') {
                debugInfo.className = 'debug-info success';
            }
        }
        
        async function initQuiz() {
            updateDebugInfo('Début de l\'initialisation du quiz');
            
            // Vérifier localStorage
            const configStr = localStorage.getItem('currentQuizConfig');
            const category = localStorage.getItem('currentQuizCategory');
            
            updateDebugInfo(`Configuration localStorage: ${configStr ? 'Trouvée' : 'Non trouvée'}`);
            updateDebugInfo(`Catégorie: ${category || 'Non définie'}`);
            
            if (!configStr || !category) {
                updateDebugInfo('Configuration manquante - Test avec données par défaut', 'error');
                // Utiliser des données de test par défaut
                useDefaultData();
                return;
            }
            
            try {
                quizConfig = JSON.parse(configStr);
                updateDebugInfo(`Configuration parsée: ${quizConfig.title}`);
                
                // Essayer de charger le fichier JSON
                updateDebugInfo(`Tentative de chargement: data/${category}_qcm.json`);
                
                const jsonFiles = {
                    't3p': 'data/t3p_prevention_qcm.json',
                    'gestion': 'data/gestion_entreprise_qcm.json',
                    'securite': 'data/securite_routiere_qcm.json',
                    'francais': 'data/francais_qcm.json',
                    'anglais': 'data/anglais_qcm.json',
                    'commercial': 'data/developpement_commercial_qcm.json',
                    'reglementation': 'data/reglementation_vtc_qcm.json'
                };
                
                const fileName = jsonFiles[category];
                if (!fileName) {
                    throw new Error(`Fichier non défini pour la catégorie: ${category}`);
                }
                
                updateDebugInfo(`Chargement du fichier: ${fileName}`);
                
                try {
                    const response = await fetch(fileName);
                    updateDebugInfo(`Réponse fetch: ${response.status} ${response.statusText}`);
                    
                    if (!response.ok) {
                        throw new Error(`Erreur HTTP: ${response.status}`);
                    }
                    
                    quizData = await response.json();
                    updateDebugInfo(`Données chargées: ${quizData.questions ? quizData.questions.length : 0} questions`, 'success');
                    
                } catch (fetchError) {
                    updateDebugInfo(`Erreur de chargement: ${fetchError.message}`, 'error');
                    updateDebugInfo('Utilisation des données de fallback');
                    quizData = getFallbackData(category);
                }
                
                if (quizData && quizData.questions && quizData.questions.length > 0) {
                    startQuiz();
                } else {
                    updateDebugInfo('Aucune question trouvée', 'error');
                }
                
            } catch (error) {
                updateDebugInfo(`Erreur d'initialisation: ${error.message}`, 'error');
                useDefaultData();
            }
        }
        
        function useDefaultData() {
            updateDebugInfo('Utilisation des données de test par défaut');
            quizConfig = {
                title: 'Test - T3P et Prévention',
                duration: 45,
                coefficient: 2,
                questions: 3,
                qrc: 0
            };
            
            quizData = {
                "matiere": "T3P et prévention des discriminations (TEST)",
                "questions": [
                    {
                        "id": 1,
                        "type": "QCM",
                        "question": "Question de test : Quel ministère gère le registre des exploitants VTC ?",
                        "options": [
                            "Ministère de l'économie",
                            "Ministère en charge du tourisme", 
                            "Ministère de l'intérieur",
                            "Ministère en charge des transports"
                        ],
                        "reponse_correcte": "d",
                        "points": 1
                    },
                    {
                        "id": 2,
                        "type": "QCM",
                        "question": "Question de test : Puis-je utiliser un véhicule acheté en janvier 2012 pour exercer la profession de VTC ?",
                        "options": [
                            "Oui, si c'est un véhicule hybride ou électrique",
                            "Non si c'est un véhicule thermique",
                            "Oui, à condition qu'il respecte les critères de puissance et de dimensions"
                        ],
                        "reponse_correcte": "b",
                        "points": 1
                    },
                    {
                        "id": 3,
                        "type": "QCM",
                        "question": "Question de test : Cette question fonctionne-t-elle ?",
                        "options": [
                            "Oui, parfaitement",
                            "Non, il y a un problème",
                            "Je ne sais pas"
                        ],
                        "reponse_correcte": "a",
                        "points": 1
                    }
                ]
            };
            
            updateDebugInfo('Données de test configurées', 'success');
            startQuiz();
        }
        
        function getFallbackData(category) {
            const fallbackData = {
                "matiere": `${category} - Version de secours`,
                "questions": [
                    {
                        "id": 1,
                        "type": "QCM",
                        "question": `Question de secours pour ${category}`,
                        "options": [
                            "Option A",
                            "Option B",
                            "Option C"
                        ],
                        "reponse_correcte": "a",
                        "points": 1
                    }
                ]
            };
            
            return fallbackData;
        }
        
        function startQuiz() {
            updateDebugInfo('Démarrage du quiz', 'success');
            document.getElementById('quizContent').style.display = 'block';
            displayQuestion();
        }
        
        function displayQuestion() {
            const question = quizData.questions[currentQuestionIndex];
            
            document.getElementById('quizTitle').textContent = quizConfig.title;
            document.getElementById('currentQ').textContent = currentQuestionIndex + 1;
            document.getElementById('totalQ').textContent = quizData.questions.length;
            document.getElementById('score').textContent = score;
            document.getElementById('questionText').textContent = question.question;
            
            // Afficher les options
            const optionsContainer = document.getElementById('optionsContainer');
            optionsContainer.innerHTML = '';
            
            question.options.forEach((option, index) => {
                const optionDiv = document.createElement('div');
                optionDiv.className = 'option';
                optionDiv.onclick = () => selectOption(index);
                
                const letter = String.fromCharCode(97 + index);
                optionDiv.innerHTML = `<strong>${letter.toUpperCase()})</strong> ${option}`;
                
                if (userAnswers[currentQuestionIndex] === letter) {
                    optionDiv.classList.add('selected');
                }
                
                optionsContainer.appendChild(optionDiv);
            });
            
            // Mettre à jour les boutons
            document.getElementById('prevBtn').disabled = currentQuestionIndex === 0;
            document.getElementById('nextBtn').textContent = 
                currentQuestionIndex === quizData.questions.length - 1 ? 'Terminer' : 'Suivant';
        }
        
        function selectOption(optionIndex) {
            document.querySelectorAll('.option').forEach(opt => opt.classList.remove('selected'));
            document.querySelectorAll('.option')[optionIndex].classList.add('selected');
            
            const letter = String.fromCharCode(97 + optionIndex);
            userAnswers[currentQuestionIndex] = letter;
            
            updateDebugInfo(`Option sélectionnée: ${letter.toUpperCase()}`);
        }
        
        function nextQuestion() {
            if (currentQuestionIndex < quizData.questions.length - 1) {
                currentQuestionIndex++;
                displayQuestion();
            } else {
                endQuiz();
            }
        }
        
        function previousQuestion() {
            if (currentQuestionIndex > 0) {
                currentQuestionIndex--;
                displayQuestion();
            }
        }
        
        function endQuiz() {
            score = 0;
            quizData.questions.forEach((question, index) => {
                if (userAnswers[index] === question.reponse_correcte) {
                    score++;
                }
            });
            
            const percentage = (score / quizData.questions.length) * 100;
            const noteVingt = (score / quizData.questions.length) * 20;
            
            updateDebugInfo(`Quiz terminé! Score: ${score}/${quizData.questions.length} (${percentage.toFixed(1)}% - ${noteVingt.toFixed(1)}/20)`, 'success');
            
            alert(`Quiz terminé!\nScore: ${score}/${quizData.questions.length}\nNote: ${noteVingt.toFixed(1)}/20\n${percentage >= 60 ? 'Réussi!' : 'Échec'}`);
        }
        
        function goHome() {
            localStorage.removeItem('currentQuizConfig');
            localStorage.removeItem('currentQuizCategory');
            window.location.href = 'index.html';
        }
        
        // Initialiser au chargement
        document.addEventListener('DOMContentLoaded', initQuiz);
    </script>
</body>
</html>
