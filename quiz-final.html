<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>QCM VTC</title>
    <style>
        body { font-family: Arial, sans-serif; max-width: 800px; margin: 0 auto; padding: 20px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); min-height: 100vh; }
        .container { background: white; border-radius: 20px; padding: 30px; margin: 20px 0; }
        .header { text-align: center; color: white; margin-bottom: 20px; }
        .question { font-size: 1.2rem; margin-bottom: 20px; color: #333; }
        .option { background: #f8f9fa; border: 2px solid #dee2e6; border-radius: 10px; padding: 15px; margin: 10px 0; cursor: pointer; transition: all 0.3s; }
        .option:hover { background: #e9ecef; }
        .option.selected { background: #e3f2fd; border-color: #2196f3; }
        .nav-btn { background: #2196f3; color: white; border: none; padding: 12px 24px; border-radius: 8px; cursor: pointer; margin: 10px; }
        .nav-btn:hover { background: #1976d2; }
        .nav-btn:disabled { background: #ccc; cursor: not-allowed; }
        .info { display: flex; justify-content: space-between; margin-bottom: 20px; color: white; }
    </style>
</head>
<body>
    <div class="header">
        <h1 id="title">QCM VTC</h1>
        <p id="subtitle">Chargement...</p>
    </div>
    
    <div class="info">
        <span>Question: <span id="current">1</span>/<span id="total">?</span></span>
        <span>Score: <span id="score">0</span></span>
        <span>Temps: <span id="timer">--:--</span></span>
    </div>
    
    <div class="container">
        <div class="question" id="question">Chargement des questions...</div>
        <div id="options"></div>
        
        <div style="text-align: center; margin-top: 20px;">
            <button class="nav-btn" onclick="previous()" id="prevBtn" disabled>Pr√©c√©dent</button>
            <button class="nav-btn" onclick="next()" id="nextBtn">Suivant</button>
            <button class="nav-btn" onclick="goHome()">Accueil</button>
        </div>
    </div>

    <script>
        console.log('Quiz-final.html charg√© !');
        
        let currentQuestion = 0;
        let questions = [];
        let answers = [];
        let score = 0;
        let timeLeft = 0;
        let config = {};
        
        // Donn√©es de test par d√©faut
        const testData = {
            "matiere": "Test QCM VTC",
            "questions": [
                {
                    "question": "Quel minist√®re g√®re le registre des exploitants VTC ?",
                    "options": ["Minist√®re de l'√©conomie", "Minist√®re du tourisme", "Minist√®re de l'int√©rieur", "Minist√®re des transports"],
                    "reponse_correcte": "d"
                },
                {
                    "question": "Un v√©hicule VTC doit √™tre √¢g√© de moins de combien d'ann√©es ?",
                    "options": ["5 ans", "6 ans", "7 ans", "8 ans"],
                    "reponse_correcte": "b"
                },
                {
                    "question": "La r√©servation pr√©alable est-elle obligatoire pour les VTC ?",
                    "options": ["Oui, toujours", "Non, jamais", "Seulement en ville", "Seulement pour l'a√©roport"],
                    "reponse_correcte": "a"
                }
            ]
        };
        
        async function init() {
            console.log('Initialisation...');
            
            // R√©cup√©rer la configuration
            const configStr = localStorage.getItem('currentQuizConfig');
            const category = localStorage.getItem('currentQuizCategory');
            
            if (configStr && category) {
                config = JSON.parse(configStr);
                console.log('Configuration trouv√©e:', config);
                document.getElementById('title').textContent = config.title;
                document.getElementById('subtitle').textContent = `${config.duration} min - Coeff ${config.coefficient}`;
                timeLeft = config.duration * 60;
                
                // Essayer de charger le fichier JSON
                try {
                    const files = {
                        't3p': 'data/t3p_prevention_qcm.json',
                        'gestion': 'data/gestion_entreprise_qcm.json',
                        'securite': 'data/securite_routiere_qcm.json',
                        'francais': 'data/francais_qcm.json',
                        'anglais': 'data/anglais_qcm.json',
                        'commercial': 'data/developpement_commercial_qcm.json',
                        'reglementation': 'data/reglementation_vtc_qcm.json'
                    };
                    
                    if (files[category]) {
                        console.log('Chargement de:', files[category]);
                        const response = await fetch(files[category]);
                        
                        if (response.ok) {
                            const data = await response.json();
                            console.log('Donn√©es charg√©es:', data);
                            questions = data.questions || [];
                        } else {
                            console.log('Erreur fetch:', response.status);
                            questions = testData.questions;
                        }
                    } else {
                        console.log('Fichier non trouv√© pour:', category);
                        questions = testData.questions;
                    }
                } catch (error) {
                    console.log('Erreur chargement JSON:', error);
                    questions = testData.questions;
                }
            } else {
                console.log('Pas de configuration, utilisation des donn√©es test');
                questions = testData.questions;
                config = { title: 'Test QCM', duration: 30, coefficient: 1 };
                timeLeft = 30 * 60;
            }
            
            if (questions.length === 0) {
                console.log('Aucune question, utilisation des donn√©es test');
                questions = testData.questions;
            }
            
            console.log('Questions finales:', questions.length);
            document.getElementById('total').textContent = questions.length;
            
            startTimer();
            showQuestion();
        }
        
        function startTimer() {
            setInterval(() => {
                if (timeLeft > 0) {
                    timeLeft--;
                    const min = Math.floor(timeLeft / 60);
                    const sec = timeLeft % 60;
                    document.getElementById('timer').textContent = 
                        `${min.toString().padStart(2, '0')}:${sec.toString().padStart(2, '0')}`;
                }
            }, 1000);
        }
        
        function showQuestion() {
            const q = questions[currentQuestion];
            document.getElementById('current').textContent = currentQuestion + 1;
            document.getElementById('question').textContent = q.question;
            document.getElementById('score').textContent = score;
            
            const optionsDiv = document.getElementById('options');
            optionsDiv.innerHTML = '';
            
            q.options.forEach((option, index) => {
                const div = document.createElement('div');
                div.className = 'option';
                div.textContent = String.fromCharCode(65 + index) + ') ' + option;
                div.onclick = () => selectOption(index);
                
                if (answers[currentQuestion] === String.fromCharCode(97 + index)) {
                    div.classList.add('selected');
                }
                
                optionsDiv.appendChild(div);
            });
            
            document.getElementById('prevBtn').disabled = currentQuestion === 0;
            document.getElementById('nextBtn').textContent = 
                currentQuestion === questions.length - 1 ? 'Terminer' : 'Suivant';
        }
        
        function selectOption(index) {
            console.log('Option s√©lectionn√©e:', index, 'Lettre:', String.fromCharCode(97 + index));
            document.querySelectorAll('.option').forEach(o => o.classList.remove('selected'));
            document.querySelectorAll('.option')[index].classList.add('selected');
            answers[currentQuestion] = String.fromCharCode(97 + index);
            console.log('R√©ponse stock√©e pour question', currentQuestion, ':', answers[currentQuestion]);
        }
        
        function next() {
            if (currentQuestion < questions.length - 1) {
                currentQuestion++;
                showQuestion();
            } else {
                finish();
            }
        }
        
        function previous() {
            if (currentQuestion > 0) {
                currentQuestion--;
                showQuestion();
            }
        }
        
        function finish() {
            score = 0;
            questions.forEach((q, i) => {
                if (answers[i] === q.reponse_correcte) score++;
            });
            
            const percent = (score / questions.length * 100).toFixed(1);
            const grade = (score / questions.length * 20).toFixed(1);
            
            // Cr√©er un √©cran de r√©sultats d√©taill√©
            const container = document.querySelector('.container');
            container.innerHTML = `
                <div style="text-align: center;">
                    <h2 style="color: ${percent >= 60 ? '#4caf50' : '#f44336'};">
                        ${percent >= 60 ? 'F√©licitations !' : '√âchec'}
                    </h2>
                    <div style="font-size: 2rem; font-weight: bold; margin: 20px 0; color: ${percent >= 60 ? '#4caf50' : '#f44336'};">
                        ${score}/${questions.length}
                    </div>
                    <p>Pourcentage: ${percent}%</p>
                    <p>Note sur 20: ${grade}/20</p>
                    <p>${percent >= 60 ? 'Vous avez r√©ussi !' : 'Il faut au moins 60% pour r√©ussir.'}</p>
                    
                    <div style="margin: 30px 0;">
                        <button class="nav-btn" onclick="showReview()">üìù Voir les r√©ponses</button>
                        <button class="nav-btn" onclick="restart()">üîÑ Recommencer</button>
                        <button class="nav-btn" onclick="goHome()">üè† Accueil</button>
                    </div>
                </div>
            `;
        }
        
        function showReview() {
            const container = document.querySelector('.container');
            let reviewHTML = '<h2 style="text-align: center; margin-bottom: 30px;">R√©vision des r√©ponses</h2>';
            
            questions.forEach((q, index) => {
                const userAnswer = answers[index];
                const correctAnswer = q.reponse_correcte;
                const isCorrect = userAnswer === correctAnswer;
                
                reviewHTML += `
                    <div style="margin-bottom: 25px; padding: 20px; border-radius: 10px; background: ${isCorrect ? '#e8f5e8' : '#ffebee'};">
                        <h4 style="color: #333; margin-bottom: 10px;">Question ${index + 1}</h4>
                        <p style="margin-bottom: 15px; font-weight: 500;">${q.question}</p>
                        <div style="margin-bottom: 8px;">
                            <strong>Votre r√©ponse:</strong> 
                            <span style="color: ${isCorrect ? '#4caf50' : '#f44336'};">
                                ${userAnswer ? q.options[userAnswer.charCodeAt(0) - 97] : 'Pas de r√©ponse'}
                            </span>
                        </div>
                        <div>
                            <strong>Bonne r√©ponse:</strong> 
                            <span style="color: #4caf50;">
                                ${q.options[correctAnswer.charCodeAt(0) - 97]}
                            </span>
                        </div>
                    </div>
                `;
            });
            
            reviewHTML += `
                <div style="text-align: center; margin-top: 30px;">
                    <button class="nav-btn" onclick="restart()">üîÑ Recommencer</button>
                    <button class="nav-btn" onclick="goHome()">üè† Accueil</button>
                </div>
            `;
            
            container.innerHTML = reviewHTML;
        }
        
        function restart() {
            currentQuestion = 0;
            answers = [];
            score = 0;
            timeLeft = config.duration * 60;
            
            // Restaurer l'interface originale
            const container = document.querySelector('.container');
            container.innerHTML = `
                <div class="question" id="question">Chargement des questions...</div>
                <div id="options"></div>
                
                <div style="text-align: center; margin-top: 20px;">
                    <button class="nav-btn" onclick="previous()" id="prevBtn" disabled>Pr√©c√©dent</button>
                    <button class="nav-btn" onclick="next()" id="nextBtn">Suivant</button>
                    <button class="nav-btn" onclick="goHome()">Accueil</button>
                </div>
            `;
            
            showQuestion();
        }
        
        function goHome() {
            localStorage.removeItem('currentQuizConfig');
            localStorage.removeItem('currentQuizCategory');
            window.location.href = 'index.html';
        }
        
        document.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>
