<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>QCM VTC - Examen</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 900px;
            margin: 0 auto;
        }
        
        .header {
            text-align: center;
            margin-bottom: 30px;
            color: white;
        }
        
        .header h1 {
            font-size: 2rem;
            margin-bottom: 10px;
        }
        
        .header .subtitle {
            font-size: 1.1rem;
            opacity: 0.9;
        }
        
        .exam-info {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 30px;
            color: white;
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 20px;
        }
        
        .info-item {
            text-align: center;
        }
        
        .info-label {
            font-size: 0.9rem;
            opacity: 0.8;
            margin-bottom: 5px;
        }
        
        .info-value {
            font-size: 1.2rem;
            font-weight: bold;
        }
        
        .progress-container {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 30px;
        }
        
        .progress-bar {
            background: rgba(255, 255, 255, 0.2);
            border-radius: 10px;
            height: 8px;
            overflow: hidden;
            margin-bottom: 10px;
        }
        
        .progress-fill {
            background: linear-gradient(90deg, #4caf50, #8bc34a);
            height: 100%;
            transition: width 0.3s ease;
        }
        
        .progress-text {
            color: white;
            text-align: center;
            font-size: 0.9rem;
        }
        
        .question-card {
            background: white;
            border-radius: 20px;
            padding: 30px;
            margin-bottom: 20px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            min-height: 400px;
            display: flex;
            flex-direction: column;
        }
        
        .question-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 25px;
            flex-wrap: wrap;
            gap: 15px;
        }
        
        .question-number {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            width: 45px;
            height: 45px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 1.1rem;
        }
        
        .question-meta {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }
        
        .question-type, .question-points {
            background: #f8f9fa;
            padding: 8px 15px;
            border-radius: 20px;
            font-size: 0.9rem;
            color: #6c757d;
            font-weight: 500;
        }
        
        .question-text {
            font-size: 1.2rem;
            color: #2c3e50;
            margin-bottom: 25px;
            line-height: 1.6;
            flex-grow: 1;
        }
        
        .options {
            display: flex;
            flex-direction: column;
            gap: 15px;
            margin-bottom: 20px;
        }
        
        .option {
            background: #f8f9fa;
            border: 2px solid transparent;
            border-radius: 12px;
            padding: 18px 22px;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 15px;
            min-height: 60px;
        }
        
        .option:hover {
            background: #e9ecef;
            border-color: #dee2e6;
            transform: translateY(-1px);
        }
        
        .option.selected {
            background: #e3f2fd;
            border-color: #2196f3;
            box-shadow: 0 4px 12px rgba(33, 150, 243, 0.2);
        }
        
        .option.correct {
            background: #e8f5e8;
            border-color: #4caf50;
            box-shadow: 0 4px 12px rgba(76, 175, 80, 0.2);
        }
        
        .option.incorrect {
            background: #ffebee;
            border-color: #f44336;
            box-shadow: 0 4px 12px rgba(244, 67, 54, 0.2);
        }
        
        .option-letter {
            background: #6c757d;
            color: white;
            width: 35px;
            height: 35px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            flex-shrink: 0;
            font-size: 1rem;
        }
        
        .option.selected .option-letter {
            background: #2196f3;
        }
        
        .option.correct .option-letter {
            background: #4caf50;
        }
        
        .option.incorrect .option-letter {
            background: #f44336;
        }
        
        .option-text {
            flex: 1;
            font-size: 1rem;
            line-height: 1.4;
        }
        
        .navigation {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 30px;
            gap: 15px;
        }
        
        .nav-btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 14px 28px;
            border-radius: 12px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            min-width: 120px;
        }
        
        .nav-btn:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(102, 126, 234, 0.4);
        }
        
        .nav-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }
        
        .nav-btn.finish {
            background: linear-gradient(135deg, #4caf50, #8bc34a);
        }
        
        .nav-btn.finish:hover:not(:disabled) {
            box-shadow: 0 6px 20px rgba(76, 175, 80, 0.4);
        }
        
        .timer {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border-radius: 12px;
            padding: 12px 20px;
            color: white;
            font-weight: bold;
            font-size: 1.1rem;
        }
        
        .timer.warning {
            background: rgba(255, 152, 0, 0.2);
            color: #ff9800;
        }
        
        .timer.danger {
            background: rgba(244, 67, 54, 0.2);
            color: #f44336;
        }
        
        .results {
            background: white;
            border-radius: 20px;
            padding: 40px;
            text-align: center;
            display: none;
        }
        
        .score-circle {
            width: 150px;
            height: 150px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 30px;
            font-size: 2rem;
            font-weight: bold;
            color: white;
        }
        
        .score-circle.pass {
            background: linear-gradient(135deg, #4caf50, #8bc34a);
        }
        
        .score-circle.fail {
            background: linear-gradient(135deg, #f44336, #ff5722);
        }
        
        .results h2 {
            font-size: 2rem;
            margin-bottom: 15px;
            color: #2c3e50;
        }
        
        .results-details {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin: 30px 0;
        }
        
        .result-item {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 12px;
        }
        
        .result-label {
            font-size: 0.9rem;
            color: #6c757d;
            margin-bottom: 8px;
        }
        
        .result-value {
            font-size: 1.5rem;
            font-weight: bold;
            color: #2c3e50;
        }
        
        .loading {
            display: flex;
            justify-content: center;
            align-items: center;
            height: 200px;
            color: white;
            font-size: 1.2rem;
        }
        
        .error {
            background: rgba(244, 67, 54, 0.1);
            color: #f44336;
            padding: 20px;
            border-radius: 12px;
            text-align: center;
            margin: 20px 0;
        }
        
        @media (max-width: 768px) {
            .container {
                padding: 10px;
            }
            
            .question-card {
                padding: 20px;
            }
            
            .navigation {
                flex-direction: column;
            }
            
            .nav-btn {
                width: 100%;
            }
            
            .exam-info {
                grid-template-columns: repeat(2, 1fr);
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1 id="examTitle">Chargement...</h1>
            <div class="subtitle" id="examSubtitle"></div>
        </div>
        
        <div class="exam-info">
            <div class="info-item">
                <div class="info-label">Question</div>
                <div class="info-value" id="currentQuestion">- / -</div>
            </div>
            <div class="info-item">
                <div class="info-label">Score</div>
                <div class="info-value" id="currentScore">0 / -</div>
            </div>
            <div class="info-item">
                <div class="info-label">Temps restant</div>
                <div class="info-value timer" id="timer">--:--</div>
            </div>
            <div class="info-item">
                <div class="info-label">Coefficient</div>
                <div class="info-value" id="coefficient">-</div>
            </div>
        </div>
        
        <div class="progress-container">
            <div class="progress-bar">
                <div class="progress-fill" id="progressFill" style="width: 0%"></div>
            </div>
            <div class="progress-text" id="progressText">Chargement...</div>
        </div>
        
        <div class="loading" id="loading">
            Chargement du questionnaire...
        </div>
        
        <div class="error" id="error" style="display: none;">
            <h3>Erreur de chargement</h3>
            <p>Impossible de charger le questionnaire. Veuillez réessayer.</p>
            <button class="nav-btn" onclick="location.reload()" style="margin-top: 15px;">
                Réessayer
            </button>
        </div>
        
        <div class="question-card" id="questionCard" style="display: none;">
            <div class="question-header">
                <div class="question-number" id="questionNumber">1</div>
                <div class="question-meta">
                    <div class="question-type" id="questionType">QCM</div>
                    <div class="question-points" id="questionPoints">1 point</div>
                </div>
            </div>
            
            <div class="question-text" id="questionText"></div>
            
            <div class="options" id="optionsContainer"></div>
        </div>
        
        <div class="navigation" id="navigation" style="display: none;">
            <button class="nav-btn" id="prevBtn" onclick="previousQuestion()" disabled>
                ← Précédent
            </button>
            <button class="nav-btn" id="homeBtn" onclick="goHome()">
                🏠 Accueil
            </button>
            <button class="nav-btn" id="nextBtn" onclick="nextQuestion()">
                Suivant →
            </button>
        </div>
        
        <div class="results" id="results">
            <div class="score-circle" id="scoreCircle">
                <span id="finalScore">0/0</span>
            </div>
            <h2 id="resultTitle">Résultats</h2>
            <p id="resultMessage"></p>
            
            <div class="results-details">
                <div class="result-item">
                    <div class="result-label">Score</div>
                    <div class="result-value" id="detailScore">0/0</div>
                </div>
                <div class="result-item">
                    <div class="result-label">Pourcentage</div>
                    <div class="result-value" id="detailPercentage">0%</div>
                </div>
                <div class="result-item">
                    <div class="result-label">Note /20</div>
                    <div class="result-value" id="detailGrade">0/20</div>
                </div>
                <div class="result-item">
                    <div class="result-label">Temps utilisé</div>
                    <div class="result-value" id="detailTime">0 min</div>
                </div>
            </div>
            
            <div style="margin-top: 30px; display: flex; gap: 15px; justify-content: center; flex-wrap: wrap;">
                <button class="nav-btn" onclick="restartQuiz()">
                    🔄 Recommencer
                </button>
                <button class="nav-btn" onclick="goHome()">
                    🏠 Accueil
                </button>
                <button class="nav-btn" onclick="reviewAnswers()" style="background: linear-gradient(135deg, #ff9800, #f57c00);">
                    📝 Réviser
                </button>
            </div>
        </div>
    </div>
    
    <script>
        let quizData = null;
        let quizConfig = null;
        let currentQuestionIndex = 0;
        let userAnswers = [];
        let score = 0;
        let timeLeft = 0;
        let timerInterval = null;
        let startTime = null;
        
        // Charger la configuration depuis localStorage
        function loadQuizConfig() {
            const configStr = localStorage.getItem('currentQuizConfig');
            const category = localStorage.getItem('currentQuizCategory');
            
            if (!configStr || !category) {
                showError('Configuration du quiz non trouvée. Retour à l\'accueil...');
                setTimeout(() => goHome(), 2000);
                return false;
            }
            
            quizConfig = JSON.parse(configStr);
            timeLeft = quizConfig.duration * 60;
            
            return true;
        }
        
        // Charger les données depuis les fichiers JSON
        async function loadQuizData() {
            try {
                const category = localStorage.getItem('currentQuizCategory');
                console.log('Catégorie:', category);
                
                // Mapping des catégories vers les fichiers JSON
                const jsonFiles = {
                    't3p': 'data/t3p_prevention_qcm.json',
                    'gestion': 'data/gestion_entreprise_qcm.json',
                    'securite': 'data/securite_routiere_qcm.json',
                    'francais': 'data/francais_qcm.json',
                    'anglais': 'data/anglais_qcm.json',
                    'commercial': 'data/developpement_commercial_qcm.json',
                    'reglementation': 'data/reglementation_vtc_qcm.json'
                };
                
                const fileName = jsonFiles[category];
                console.log('Fichier à charger:', fileName);
                
                if (!fileName) {
                    throw new Error(`Fichier non trouvé pour la catégorie: ${category}`);
                }
                
                try {
                    const response = await fetch(fileName);
                    console.log('Réponse fetch:', response.status, response.statusText);
                    
                    if (!response.ok) {
                        throw new Error(`Erreur HTTP: ${response.status}`);
                    }
                    
                    const data = await response.json();
                    console.log('Données chargées:', data);
                    
                    if (!data || !data.questions || data.questions.length === 0) {
                        throw new Error('Aucune question trouvée dans le fichier JSON');
                    }
                    
                    return data;
                    
                } catch (fetchError) {
                    console.error('Erreur de chargement:', fetchError);
                    console.log('Utilisation des données de fallback');
                    return getFallbackData(category);
                }
                
            } catch (error) {
                console.error('Erreur lors du chargement des données:', error);
                return getFallbackData('t3p'); // Fallback par défaut
            }
        }
        
        // Données de fallback si les fichiers JSON ne sont pas trouvés
        function getFallbackData(category) {
            console.log('Chargement des données de fallback pour:', category);
            
            const fallbackData = {
                't3p': {
                    "matiere": "T3P et prévention des discriminations (Données de test)",
                    "duree": "45 minutes",
                    "points": 20,
                    "coefficient": 2,
                    "questions": [
                        {
                            "id": 1,
                            "type": "QCM",
                            "question": "Quel ministère gère le registre des exploitants VTC ?",
                            "options": [
                                "Ministère de l'économie",
                                "Ministère en charge du tourisme", 
                                "Ministère de l'intérieur",
                                "Ministère en charge des transports"
                            ],
                            "reponse_correcte": "d",
                            "points": 1
                        },
                        {
                            "id": 2,
                            "type": "QCM",
                            "question": "Puis-je utiliser un véhicule acheté en janvier 2012 pour exercer la profession de VTC ?",
                            "options": [
                                "Oui, si c'est un véhicule hybride ou électrique",
                                "Non si c'est un véhicule thermique",
                                "Oui, à condition qu'il respecte les critères de puissance et de dimensions"
                            ],
                            "reponse_correcte": "b",
                            "points": 1
                        },
                        {
                            "id": 3,
                            "type": "QCM", 
                            "question": "L'arrêté du 6 Avril 2017 relatif à la signalétique définitive des voitures de transport avec chauffeur impose :",
                            "options": [
                                "Une vignette ronde de couleur rouge",
                                "2 vignettes rondes de couleur rouge",
                                "2 vignettes rondes de couleur mauve"
                            ],
                            "reponse_correcte": "c",
                            "points": 1
                        }
                    ]
                },
                'gestion': {
                    "matiere": "Gestion d'entreprise (Données de test)",
                    "questions": [
                        {
                            "id": 1,
                            "type": "QCM",
                            "question": "Quand il y a franchise de TVA cela signifie que :",
                            "options": [
                                "La déclaration de TVA sera faite ultérieurement",
                                "La prestation n'est pas assujettie à la TVA",
                                "L'entreprise ne peut pas récupérer la TVA"
                            ],
                            "reponse_correcte": "b",
                            "points": 1
                        }
                    ]
                }
            };
            
            return fallbackData[category] || fallbackData['t3p'];
        }
        
        // Charger les données depuis les fichiers JSON
        async function getQuizDataForCategory(category) {
            try {
                // Mapping des catégories vers les fichiers JSON
                const jsonFiles = {
                    't3p': 'data/t3p_prevention_qcm.json',
                    'gestion': 'data/gestion_entreprise_qcm.json',
                    'securite': 'data/securite_routiere_qcm.json',
                    'francais': 'data/francais_qcm.json',
                    'anglais': 'data/anglais_qcm.json',
                    'commercial': 'data/developpement_commercial_qcm.json',
                    'reglementation': 'data/reglementation_vtc_qcm.json'
                };
                
                const fileName = jsonFiles[category];
                if (!fileName) {
                    throw new Error(`Fichier non trouvé pour la catégorie: ${category}`);
                }
                
                const response = await fetch(fileName);
                if (!response.ok) {
                    throw new Error(`Erreur HTTP: ${response.status}`);
                }
                
                const data = await response.json();
                return data;
                
            } catch (error) {
                console.error('Erreur lors du chargement des données:', error);
                
                // Fallback avec données de base si le fichier JSON n'existe pas
                return getFallbackData(category);
            }
        }
        
        // Données de fallback si les fichiers JSON ne sont pas trouvés
        function getFallbackData(category) {
            const fallbackData = {
                't3p': {
                    "matiere": "T3P et prévention des discriminations sexuelles et sexistes",
                    "duree": "45 minutes",
                    "points": 20,
                    "coefficient": 2,
                    "questions": [
                        {
                            "id": 1,
                            "type": "QCM",
                            "question": "Quel ministère gère le registre des exploitants VTC ?",
                            "options": [
                                "Ministère de l'économie",
                                "Ministère en charge du tourisme", 
                                "Ministère de l'intérieur",
                                "Ministère en charge des transports"
                            ],
                            "reponse_correcte": "d",
                            "points": 1
                        },
                        {
                            "id": 2,
                            "type": "QCM",
                            "question": "Puis-je utiliser un véhicule acheté en janvier 2012 pour exercer la profession de VTC ?",
                            "options": [
                                "Oui, si c'est un véhicule hybride ou électrique",
                                "Non si c'est un véhicule thermique",
                                "Oui, à condition qu'il respecte les critères de puissance et de dimensions"
                            ],
                            "reponse_correcte": "b",
                            "points": 1
                        },
                        {
                            "id": 3,
                            "type": "QCM", 
                            "question": "L'arrêté du 6 Avril 2017 relatif à la signalétique définitive des voitures de transport avec chauffeur impose :",
                            "options": [
                                "Une vignette ronde de couleur rouge",
                                "2 vignettes rondes de couleur rouge",
                                "2 vignettes rondes de couleur mauve"
                            ],
                            "reponse_correcte": "c",
                            "points": 1
                        }
                    ]
                },
                'gestion': {
                    "matiere": "Gestion d'entreprise",
                    "duree": "30 minutes", 
                    "points": 20,
                    "coefficient": 3,
                    "questions": [
                        {
                            "id": 1,
                            "type": "QCM",
                            "question": "Quand il y a franchise de TVA cela signifie que :",
                            "options": [
                                "La déclaration de TVA sera faite ultérieurement",
                                "La prestation n'est pas assujettie à la TVA",
                                "L'entreprise ne peut pas récupérer la TVA"
                            ],
                            "reponse_correcte": "b",
                            "points": 1
                        },
                        {
                            "id": 2,
                            "type": "QCM",
                            "question": "Quelle situation permet d'avoir un crédit de TVA :",
                            "options": [
                                "TVA collectée supérieure à TVA déductible",
                                "TVA collectée est inférieure TVA déductible",
                                "TVA collectée = TVA déductible"
                            ],
                            "reponse_correcte": "b",
                            "points": 1
                        }
                    ]
                },
                'securite': {
                    "matiere": "Sécurité routière",
                    "duree": "30 minutes",
                    "points": 20,
                    "coefficient": 3,
                    "questions": [
                        {
                            "id": 1,
                            "type": "QCM",
                            "question": "Pour faire établir une nouvelle carte grise lors d'un changement de domicile, le propriétaire dispose de :",
                            "options": [
                                "3 semaines",
                                "1 mois",
                                "15 jours"
                            ],
                            "reponse_correcte": "b",
                            "points": 1
                        }
                    ]
                },
                'francais': {
                    "matiere": "Français",
                    "duree": "30 minutes",
                    "points": 20,
                    "coefficient": 2,
                    "questions": [
                        {
                            "id": 1,
                            "type": "QCM",
                            "question": "Que signifie le mot « recensement » ?",
                            "options": [
                                "Enquête",
                                "Recueil d'informations",
                                "Traitement de statistiques",
                                "Dénombrement détaillé"
                            ],
                            "reponse_correcte": "d",
                            "points": 2
                        }
                    ]
                },
                'anglais': {
                    "matiere": "Anglais",
                    "duree": "30 minutes",
                    "points": 20,
                    "coefficient": 1,
                    "questions": [
                        {
                            "id": 1,
                            "type": "QCM",
                            "question": "Il y a un supplément pour la quatrième personne",
                            "options": [
                                "There is no extra charge for the fourth person",
                                "There is a supplement for the third person",
                                "There is an extra charge for the fourth person"
                            ],
                            "reponse_correcte": "c",
                            "points": 1
                        }
                    ]
                },
                'commercial': {
                    "matiere": "Développement commercial",
                    "duree": "30 minutes",
                    "points": 20,
                    "coefficient": 3,
                    "questions": [
                        {
                            "id": 1,
                            "type": "QCM",
                            "question": "À l'aéroport, le parking professionnel est saturé alors que vos clients ne vont pas tarder à sortir du check out :",
                            "options": [
                                "Vous vous garez sur des zébras",
                                "Vous vous garez au niveau de la dépose taxi car c'est au niveau des arrivées",
                                "Vous vous garez au parking public",
                                "Vous attendez qu'une place se libère"
                            ],
                            "reponse_correcte": "c",
                            "points": 1
                        }
                    ]
                },
                'reglementation': {
                    "matiere": "Réglementation nationale VTC",
                    "duree": "20 minutes",
                    "points": 20,
                    "coefficient": 3,
                    "questions": [
                        {
                            "id": 1,
                            "type": "QCM",
                            "question": "La durée maximale de stationnement précédant l'horaire de prise en charge mentionné par le client lors de sa réservation à un aéroport ou une gare pour un VTC est de :",
                            "options": [
                                "30 minutes",
                                "45 minutes",
                                "1 heure",
                                "1h30"
                            ],
                            "reponse_correcte": "c",
                            "points": 2
                        }
                    ]
                }
            };
            
            return fallbackData[category] || fallbackData['t3p'];
        }
        
        function showError(message) {
            document.getElementById('loading').style.display = 'none';
            document.getElementById('error').style.display = 'block';
            document.getElementById('error').querySelector('p').textContent = message;
        }
        
        async function initQuiz() {
            console.log('Initialisation du quiz...');
            
            // Charger la configuration
            if (!loadQuizConfig()) {
                console.error('Échec du chargement de la configuration');
                return;
            }
            
            console.log('Configuration chargée:', quizConfig);
            
            // Mettre à jour l'interface avec les infos du quiz
            document.getElementById('examTitle').textContent = quizConfig.title;
            document.getElementById('examSubtitle').textContent = 
                `${quizConfig.duration} minutes - Coefficient ${quizConfig.coefficient} - ${quizConfig.questions} QCM` + 
                (quizConfig.qrc > 0 ? ` + ${quizConfig.qrc} QRC` : '');
            document.getElementById('coefficient').textContent = quizConfig.coefficient;
            
            // Charger les données
            console.log('Chargement des données du quiz...');
            try {
                quizData = await loadQuizData();
                
                if (!quizData || !quizData.questions || quizData.questions.length === 0) {
                    throw new Error('Aucune donnée de quiz valide');
                }
                
                console.log('Quiz chargé avec succès:', quizData.questions.length, 'questions');
                
                // Masquer le chargement et afficher le quiz
                document.getElementById('loading').style.display = 'none';
                document.getElementById('questionCard').style.display = 'block';
                document.getElementById('navigation').style.display = 'flex';
                
                startTime = Date.now();
                startTimer();
                displayQuestion();
                
            } catch (error) {
                console.error('Erreur lors du chargement du quiz:', error);
                showError(`Erreur de chargement: ${error.message}`);
            }
        }
        
        function startTimer() {
            updateTimerDisplay();
            timerInterval = setInterval(() => {
                timeLeft--;
                updateTimerDisplay();
                if (timeLeft <= 0) {
                    endQuiz();
                }
            }, 1000);
        }
        
        function updateTimerDisplay() {
            const minutes = Math.floor(timeLeft / 60);
            const seconds = timeLeft % 60;
            const timerElement = document.getElementById('timer');
            
            timerElement.textContent = 
                `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
            
            // Changer la couleur selon le temps restant
            timerElement.className = 'timer';
            if (timeLeft <= 300) { // 5 minutes
                timerElement.className += ' danger';
            } else if (timeLeft <= 600) { // 10 minutes
                timerElement.className += ' warning';
            }
        }
        
        function displayQuestion() {
            const question = quizData.questions[currentQuestionIndex];
            
            // Mettre à jour les infos
            document.getElementById('questionNumber').textContent = currentQuestionIndex + 1;
            document.getElementById('questionText').textContent = question.question;
            document.getElementById('currentQuestion').textContent = 
                `${currentQuestionIndex + 1} / ${quizData.questions.length}`;
            document.getElementById('currentScore').textContent = `${score} / ${quizData.questions.length}`;
            document.getElementById('questionType').textContent = question.type || 'QCM';
            document.getElementById('questionPoints').textContent = `${question.points || 1} point${(question.points || 1) > 1 ? 's' : ''}`;
            
            // Mettre à jour la barre de progression
            const progress = ((currentQuestionIndex + 1) / quizData.questions.length) * 100;
            document.getElementById('progressFill').style.width = progress + '%';
            document.getElementById('progressText').textContent = 
                `Question ${currentQuestionIndex + 1} sur ${quizData.questions.length}`;
            
            // Afficher les options
            const optionsContainer = document.getElementById('optionsContainer');
            optionsContainer.innerHTML = '';
            
            question.options.forEach((option, index) => {
                const optionDiv = document.createElement('div');
                optionDiv.className = 'option';
                optionDiv.onclick = () => selectOption(index);
                
                const letter = String.fromCharCode(97 + index); // a, b, c, d
                optionDiv.innerHTML = `
                    <div class="option-letter">${letter.toUpperCase()}</div>
                    <div class="option-text">${option}</div>
                `;
                
                // Restaurer la sélection si elle existe
                if (userAnswers[currentQuestionIndex] === letter) {
                    optionDiv.classList.add('selected');
                }
                
                optionsContainer.appendChild(optionDiv);
            });
            
            // Mettre à jour les boutons de navigation
            document.getElementById('prevBtn').disabled = currentQuestionIndex === 0;
            const nextBtn = document.getElementById('nextBtn');
            if (currentQuestionIndex === quizData.questions.length - 1) {
                nextBtn.textContent = '🏁 Terminer';
                nextBtn.className = 'nav-btn finish';
            } else {
                nextBtn.textContent = 'Suivant →';
                nextBtn.className = 'nav-btn';
            }
        }
        
        function selectOption(optionIndex) {
            // Supprimer la sélection précédente
            document.querySelectorAll('.option').forEach(opt => opt.classList.remove('selected'));
            
            // Ajouter la sélection
            document.querySelectorAll('.option')[optionIndex].classList.add('selected');
            
            // Stocker la réponse
            const letter = String.fromCharCode(97 + optionIndex);
            userAnswers[currentQuestionIndex] = letter;
        }
        
        function nextQuestion() {
            if (currentQuestionIndex < quizData.questions.length - 1) {
                currentQuestionIndex++;
                displayQuestion();
            } else {
                endQuiz();
            }
        }
        
        function previousQuestion() {
            if (currentQuestionIndex > 0) {
                currentQuestionIndex--;
                displayQuestion();
            }
        }
        
        function endQuiz() {
            if (timerInterval) {
                clearInterval(timerInterval);
            }
            calculateScore();
            showResults();
        }
        
        function calculateScore() {
            score = 0;
            quizData.questions.forEach((question, index) => {
                if (userAnswers[index] === question.reponse_correcte) {
                    score++;
                }
            });
        }
        
        function showResults() {
            document.getElementById('questionCard').style.display = 'none';
            document.getElementById('navigation').style.display = 'none';
            
            const percentage = (score / quizData.questions.length) * 100;
            const noteVingt = (score / quizData.questions.length) * 20;
            const endTime = Date.now();
            const timeUsed = Math.round((endTime - startTime) / 1000 / 60); // en minutes
            
            // Déterminer si c'est réussi (note minimale requise)
            const minGradeRequired = 6; // Note minimale sur 20
            const passed = noteVingt >= minGradeRequired;
            
            // Mettre à jour les éléments
            document.getElementById('finalScore').textContent = `${score}/${quizData.questions.length}`;
            document.getElementById('scoreCircle').className = `score-circle ${passed ? 'pass' : 'fail'}`;
            document.getElementById('resultTitle').textContent = passed ? 'Félicitations !' : 'Échec';
            document.getElementById('resultMessage').textContent = passed 
                ? `Vous avez réussi l'épreuve de ${quizConfig.title} !`
                : `Note insuffisante. Il faut au moins ${minGradeRequired}/20 pour valider cette épreuve.`;
            
            // Détails des résultats
            document.getElementById('detailScore').textContent = `${score}/${quizData.questions.length}`;
            document.getElementById('detailPercentage').textContent = `${percentage.toFixed(1)}%`;
            document.getElementById('detailGrade').textContent = `${noteVingt.toFixed(1)}/20`;
            document.getElementById('detailTime').textContent = `${timeUsed} min`;
            
            document.getElementById('results').style.display = 'block';
            
            // Sauvegarder les résultats
            saveQuizResult(score, quizData.questions.length, noteVingt, passed);
        }
        
        function saveQuizResult(score, total, grade, passed) {
            const category = localStorage.getItem('currentQuizCategory');
            const results = JSON.parse(localStorage.getItem('quizResults') || '{}');
            
            results[category] = {
                score: score,
                total: total,
                grade: grade,
                passed: passed,
                date: new Date().toISOString(),
                timeUsed: Math.round((Date.now() - startTime) / 1000 / 60)
            };
            
            localStorage.setItem('quizResults', JSON.stringify(results));
        }
        
        function restartQuiz() {
            currentQuestionIndex = 0;
            userAnswers = [];
            score = 0;
            timeLeft = quizConfig.duration * 60;
            startTime = null;
            
            document.getElementById('questionCard').style.display = 'block';
            document.getElementById('navigation').style.display = 'flex';
            document.getElementById('results').style.display = 'none';
            
            initQuiz();
        }
        
        function reviewAnswers() {
            // Créer une page de révision
            let reviewHTML = `
                <div style="background: white; border-radius: 20px; padding: 30px; margin-top: 20px;">
                    <h2 style="text-align: center; margin-bottom: 30px; color: #2c3e50;">Révision des réponses</h2>
            `;
            
            quizData.questions.forEach((question, index) => {
                const userAnswer = userAnswers[index];
                const correctAnswer = question.reponse_correcte;
                const isCorrect = userAnswer === correctAnswer;
                
                reviewHTML += `
                    <div style="margin-bottom: 30px; padding: 20px; border-radius: 12px; background: ${isCorrect ? '#e8f5e8' : '#ffebee'};">
                        <h4 style="color: #2c3e50; margin-bottom: 15px;">Question ${index + 1}</h4>
                        <p style="margin-bottom: 15px; font-weight: 500;">${question.question}</p>
                        <div style="margin-bottom: 10px;">
                            <strong>Votre réponse:</strong> 
                            <span style="color: ${isCorrect ? '#4caf50' : '#f44336'};">
                                ${userAnswer ? question.options[userAnswer.charCodeAt(0) - 97] : 'Pas de réponse'}
                            </span>
                        </div>
                        <div>
                            <strong>Bonne réponse:</strong> 
                            <span style="color: #4caf50;">
                                ${question.options[correctAnswer.charCodeAt(0) - 97]}
                            </span>
                        </div>
                    </div>
                `;
            });
            
            reviewHTML += `
                    <div style="text-align: center; margin-top: 30px;">
                        <button class="nav-btn" onclick="closeReview()">Fermer la révision</button>
                    </div>
                </div>
            `;
            
            document.getElementById('results').innerHTML = reviewHTML;
        }
        
        function closeReview() {
            showResults(); // Retour aux résultats normaux
        }
        
        function goHome() {
            // Nettoyer le localStorage
            localStorage.removeItem('currentQuizConfig');
            localStorage.removeItem('currentQuizCategory');
            window.location.href = 'index.html';
        }
        
        // Gestion des raccourcis clavier
        document.addEventListener('keydown', function(event) {
            if (document.getElementById('questionCard').style.display !== 'none') {
                // Touches 1-4 pour sélectionner les options
                if (event.key >= '1' && event.key <= '4') {
                    const optionIndex = parseInt(event.key) - 1;
                    const question = quizData.questions[currentQuestionIndex];
                    if (optionIndex < question.options.length) {
                        selectOption(optionIndex);
                    }
                }
                // Flèche droite ou Entrée pour question suivante
                else if (event.key === 'ArrowRight' || event.key === 'Enter') {
                    nextQuestion();
                }
                // Flèche gauche pour question précédente
                else if (event.key === 'ArrowLeft') {
                    previousQuestion();
                }
            }
        });
        
        // Initialiser le quiz au chargement de la page
        document.addEventListener('DOMContentLoaded', initQuiz);
